package com.example.view;

import com.example.constant.ConstantUtil;
import com.example.mybeatplane.R;
import com.example.sounds.GameSoundPool;
import android.content.Context;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.graphics.Color;
import android.graphics.Rect;
import android.view.MotionEvent;
import android.view.SurfaceHolder;

import java.util.Timer;
import java.util.TimerTask;

/*ÓÎÏ·¿ªÊ¼Ç°µÄ½çÃæÀà*/
public class ReadyView extends BaseView{
	private float fly_x;					// Í¼Æ¬µÄ×ø±ê
	Timer mTimer = new Timer();
	private float fly_y;
	private float bg_x;					// ±³¾°µÄ×ø±ê
	private float bg_y;
	private float bg_wight;					// ±³¾°Í¼Æ¬µÄ´óÐ¡
	private float bg_hight;
	private float fly_height;
	private float text_x;
	private float text_y;
	private float button_x;
	private float button_y;
	private float button_y2;
	private float strwid;
	private float strhei;
	private boolean isBtChange;				// °´Å¥Í¼Æ¬¸Ä±äµÄ±ê¼Ç
	private boolean isBtChange2;
	private String startGame = "START";	// °´Å¥µÄÎÄ×Ö
	private String exitGame = "EXIT";
	private Bitmap text;					// ÎÄ×ÖÍ¼Æ¬
	private Bitmap button;					// °´Å¥Í¼Æ¬
	private Bitmap button2;					// °´Å¥Í¼Æ¬
	private Bitmap planefly;				// ·É»ú·ÉÐÐµÄÍ¼Æ¬
	private Bitmap background;				// ±³¾°Í¼Æ¬
	private Bitmap background1;				// ±³¾°Í¼Æ¬
	private Bitmap background2;				// ±³¾°Í¼Æ¬
	private Bitmap background3;				// ±³¾°Í¼Æ¬
	private Bitmap background4;				// ±³¾°Í¼Æ¬
	private Bitmap background5;				// ±³¾°Í¼Æ¬
	private Bitmap background6;				// ±³¾°Í¼Æ¬
	private Bitmap background7;				// ±³¾°Í¼Æ¬
	private Bitmap background8;				// ±³¾°Í¼Æ¬
	private Bitmap background9;				// ±³¾°Í¼Æ¬
	private Bitmap background10;				// ±³¾°Í¼Æ¬
	private Bitmap background11;				// ±³¾°Í¼Æ¬
	private Bitmap background12;				// ±³¾°Í¼Æ¬
	private Bitmap background13;				// ±³¾°Í¼Æ¬
	private Bitmap background14;				// ±³¾°Í¼Æ¬
	private Bitmap background15;				// ±³¾°Í¼Æ¬
	private Bitmap background16;				// ±³¾°Í¼Æ¬
	private Bitmap background17;				// ±³¾°Í¼Æ¬
	private Bitmap background18;				// ±³¾°Í¼Æ¬
	private Bitmap background19;				// ±³¾°Í¼Æ¬
	private Bitmap background20;				// ±³¾°Í¼Æ¬
	private Rect rect;						// »æÖÆÎÄ×ÖµÄÇøÓò
	public ReadyView(Context context,GameSoundPool sounds) {
		super(context,sounds);
		// TODO Auto-generated constructor stub
		paint.setTextSize(40);
		rect = new Rect();
		thread = new Thread(this);
	}
	// ÊÓÍ¼¸Ä±äµÄ·½·¨
	@Override
	public void surfaceChanged(SurfaceHolder arg0, int arg1, int arg2, int arg3) {
		// TODO Auto-generated method stub
		super.surfaceChanged(arg0, arg1, arg2, arg3);
	}
	// ÊÓÍ¼´´½¨µÄ·½·¨
	@Override
	public void surfaceCreated(SurfaceHolder arg0) {
		// TODO Auto-generated method stub
		super.surfaceCreated(arg0);
		initBitmap(); 
		if(thread.isAlive()){
			thread.start();
		}
		else{
			thread = new Thread(this);
			thread.start();
		}
	}
	// ÊÓÍ¼Ïú»ÙµÄ·½·¨
	@Override
	public void surfaceDestroyed(SurfaceHolder arg0) {
		// TODO Auto-generated method stub
		super.surfaceDestroyed(arg0);
		release();
	}
	// ÏìÓ¦´¥ÆÁÊÂ¼þµÄ·½·¨
	@Override
	public boolean onTouchEvent(MotionEvent event) {
		if (event.getAction() == MotionEvent.ACTION_DOWN
				&& event.getPointerCount() == 1) {
			float x = event.getX();
			float y = event.getY();
			//ÅÐ¶ÏµÚÒ»¸ö°´Å¥ÊÇ·ñ±»°´ÏÂ
			if (x > button_x && x < button_x + button.getWidth()
					&& y > button_y && y < button_y + button.getHeight()) {
				sounds.playSound(7, 0);
				isBtChange = true;
				drawSelf();
				mainActivity.getHandler().sendEmptyMessage(ConstantUtil.TO_MAIN_VIEW);
			}
			//ÅÐ¶ÏµÚ¶þ¸ö°´Å¥ÊÇ·ñ±»°´ÏÂ
			else if (x > button_x && x < button_x + button.getWidth()
					&& y > button_y2 && y < button_y2 + button.getHeight()) {
				sounds.playSound(7, 0);
				isBtChange2 = true;
				drawSelf();
				mTimer.cancel(); //ÍË³ö¼ÆÊ±Æ÷
				mainActivity.getHandler().sendEmptyMessage(ConstantUtil.END_GAME);
			}
			return true;
		} 
		//ÏìÓ¦ÆÁÄ»µ¥µãÒÆ¶¯µÄÏûÏ¢
		else if (event.getAction() == MotionEvent.ACTION_MOVE) {
			float x = event.getX();
			float y = event.getY();
			if (x > button_x && x < button_x + button.getWidth()
					&& y > button_y && y < button_y + button.getHeight()) {
				isBtChange = true;
			} else {
				isBtChange = false;
			}
			if (x > button_x && x < button_x + button.getWidth()
					&& y > button_y2 && y < button_y2 + button.getHeight()) {
				isBtChange2 = true;
			} else {
				isBtChange2 = false;
			}
			return true;
		} 
		//ÏìÓ¦ÊÖÖ¸Àë¿ªÆÁÄ»µÄÏûÏ¢
		else if (event.getAction() == MotionEvent.ACTION_UP) {
			isBtChange = false;
			isBtChange2 = false;
			return true;
		}
		return false;
	}
	// ³õÊ¼»¯Í¼Æ¬×ÊÔ´·½·¨
	@Override
	public void initBitmap() {
		// TODO Auto-generated method stub


		mTimer.schedule(task,1000, 24000); //ÑÓÊ±1000msºóÖ´ÐÐ£¬1000msÖ´ÐÐÒ»´Î

		background = BitmapFactory.decodeResource(getResources(),R.drawable.bg_1);
		background1 = BitmapFactory.decodeResource(getResources(),R.drawable.bg_2);
		background2 = BitmapFactory.decodeResource(getResources(),R.drawable.bg_3);
		background3 = BitmapFactory.decodeResource(getResources(),R.drawable.bg_4);
		background4 = BitmapFactory.decodeResource(getResources(),R.drawable.bg_5);
		background5 = BitmapFactory.decodeResource(getResources(),R.drawable.bg_6);
		background6 = BitmapFactory.decodeResource(getResources(),R.drawable.bg_7);
		background7 = BitmapFactory.decodeResource(getResources(),R.drawable.bg_8);
		background8 = BitmapFactory.decodeResource(getResources(),R.drawable.bg_9);
		background9 = BitmapFactory.decodeResource(getResources(),R.drawable.bg_10);
		background10 = BitmapFactory.decodeResource(getResources(),R.drawable.bg_11);
		background11 = BitmapFactory.decodeResource(getResources(),R.drawable.bg_12);
		background12 = BitmapFactory.decodeResource(getResources(),R.drawable.bg_13);
		background13 = BitmapFactory.decodeResource(getResources(),R.drawable.bg_14);
		background14 = BitmapFactory.decodeResource(getResources(),R.drawable.bg_15);
		background15 = BitmapFactory.decodeResource(getResources(),R.drawable.bg_16);
		background16 = BitmapFactory.decodeResource(getResources(),R.drawable.bg_17);
		background17 = BitmapFactory.decodeResource(getResources(),R.drawable.bg_18);
		background18 = BitmapFactory.decodeResource(getResources(),R.drawable.bg_19);
		background19 = BitmapFactory.decodeResource(getResources(),R.drawable.bg_20);

		text = BitmapFactory.decodeResource(getResources(), R.drawable.text);
		planefly = BitmapFactory.decodeResource(getResources(), R.drawable.fish);
		button = BitmapFactory.decodeResource(getResources(), R.drawable.bt_start);
		button2 = BitmapFactory.decodeResource(getResources(),R.drawable.bt_exit);
		bg_x = 0;
		bg_y = 0;
		bg_wight = background.getWidth();
		bg_hight = background.getHeight()/4;
		scalex = screen_width / background.getWidth();
		scaley = screen_height / background.getHeight();
		text_x = screen_width / 2 - text.getWidth() / 2;
		text_y = screen_height / 2 - text.getHeight();
		fly_x = screen_width / 2 - planefly.getWidth() / 2;
		fly_height = planefly.getHeight() / 4;
		fly_y = text_y - fly_height ;
		button_x = screen_width / 2 - button.getWidth() / 2;
		button_y = screen_height / 2 + button.getHeight();
		button_y2 = button_y + button.getHeight() + 40;
		// ·µ»Ø°üÎ§Õû¸ö×Ö·û´®µÄ×îÐ¡µÄÒ»¸öRectÇøÓò
		paint.getTextBounds(startGame, 0, startGame.length(), rect);
		strwid = rect.width();
		strhei = rect.height();
	}
	// ÊÍ·ÅÍ¼Æ¬×ÊÔ´µÄ·½·¨
	@Override
	public void release() {
		// TODO Auto-generated method stub
		if (!text.isRecycled()) {
			text.recycle();
		}
		if (!button.isRecycled()) {
			button.recycle();
		}
		if (!button2.isRecycled()) {
			button2.recycle();
		}	
		if (!planefly.isRecycled()) {
			planefly.recycle();
		}
		if (!background.isRecycled()) {
			background.recycle();
		}
		mTimer.cancel(); //ÍË³ö¼ÆÊ±Æ÷
	}
	// »æÍ¼·½·¨
	@Override
	public void drawSelf() {
		// TODO Auto-generated method stub
		try {
			canvas = sfh.lockCanvas();
			canvas.drawColor(Color.BLACK); 						// »æÖÆ±³¾°É«
			canvas.save();
			canvas.scale(scalex, scaley, 0, 0);					// ¼ÆËã±³¾°Í¼Æ¬ÓëÆÁÄ»µÄ±ÈÀý
			if(currentFrame2 == 0)
			    canvas.drawBitmap(background, 0, 0, paint); 		// »æÖÆ±³¾°Í¼
			if(currentFrame2 == 1)
				canvas.drawBitmap(background1, 0, 0, paint); 		// »æÖÆ±³¾°Í¼
			if(currentFrame2 == 2)
				canvas.drawBitmap(background2, 0, 0, paint); 		// »æÖÆ±³¾°Í¼
			if(currentFrame2 == 3)
				canvas.drawBitmap(background3, 0, 0, paint); 		// »æÖÆ±³¾°Í¼
			if(currentFrame2 == 4)
				canvas.drawBitmap(background4, 0, 0, paint); 		// »æÖÆ±³¾°Í¼
			if(currentFrame2 == 5)
				canvas.drawBitmap(background5, 0, 0, paint); 		// »æÖÆ±³¾°Í¼
			if(currentFrame2 == 6)
				canvas.drawBitmap(background6, 0, 0, paint); 		// »æÖÆ±³¾°Í¼
			if(currentFrame2 == 7)
				canvas.drawBitmap(background7, 0, 0, paint); 		// »æÖÆ±³¾°Í¼
			if(currentFrame2 == 8)
				canvas.drawBitmap(background8, 0, 0, paint); 		// »æÖÆ±³¾°Í¼
			if(currentFrame2 == 9)
				canvas.drawBitmap(background9, 0, 0, paint); 		// »æÖÆ±³¾°Í¼
			if(currentFrame2 == 10)
				canvas.drawBitmap(background10, 0, 0, paint); 		// »æÖÆ±³¾°Í¼
			if(currentFrame2 == 11)
				canvas.drawBitmap(background11, 0, 0, paint); 		// »æÖÆ±³¾°Í¼
			if(currentFrame2 == 12)
				canvas.drawBitmap(background12, 0, 0, paint); 		// »æÖÆ±³¾°Í¼
			if(currentFrame2 == 13)
				canvas.drawBitmap(background13, 0, 0, paint); 		// »æÖÆ±³¾°Í¼
			if(currentFrame2 == 14)
				canvas.drawBitmap(background14, 0, 0, paint); 		// »æÖÆ±³¾°Í¼
			if(currentFrame2 == 15)
				canvas.drawBitmap(background15, 0, 0, paint); 		// »æÖÆ±³¾°Í¼
			if(currentFrame2 == 16)
				canvas.drawBitmap(background16, 0, 0, paint); 		// »æÖÆ±³¾°Í¼
			if(currentFrame2 == 17)
				canvas.drawBitmap(background17, 0, 0, paint); 		// »æÖÆ±³¾°Í¼
			if(currentFrame2 == 18)
				canvas.drawBitmap(background18, 0, 0, paint); 		// »æÖÆ±³¾°Í¼
			if(currentFrame2 == 19)
				canvas.drawBitmap(background19, 0, 0, paint); 		// »æÖÆ±³¾°Í¼
			currentFrame2++;
			if(currentFrame2>=20)
				currentFrame2=0;

			canvas.restore();
			canvas.drawBitmap(text, text_x, text_y, paint);		// »æÖÆÎÄ×ÖÍ¼Æ¬
			//µ±ÊÖÖ¸»¬¹ý°´Å¥Ê±±ä»»Í¼Æ¬
			canvas.drawBitmap(button, button_x, button_y, paint);
			canvas.drawBitmap(button2, button_x, button_y2, paint);

			//·É»ú·ÉÐÐµÄ¶¯»­
			canvas.save();
			canvas.clipRect(fly_x, fly_y-20, fly_x + planefly.getWidth(), fly_y + fly_height+20);
			canvas.drawBitmap(planefly, fly_x, fly_y - currentFrame * fly_height+20,paint);
			currentFrame++;
			if (currentFrame >= 4) {
				currentFrame = 0;
			}
			canvas.restore();
		} catch (Exception err) {
			err.printStackTrace();
		} finally {
			if (canvas != null)
				sfh.unlockCanvasAndPost(canvas);
		}
	}
	TimerTask task = new TimerTask(){
		public void run() {
			sounds.playSound(1, 1);	  //×Óµ¯ÒôÐ§
		}
	};
	// Ïß³ÌÔËÐÐµÄ·½·¨
	@Override
	public void run() {
		// TODO Auto-generated method stub
		while (threadFlag) {
			long startTime = System.currentTimeMillis();
			drawSelf();
			long endTime = System.currentTimeMillis();
			try {
				if (endTime - startTime < 400)
					Thread.sleep(400 - (endTime - startTime));
			} catch (InterruptedException err) {
				err.printStackTrace();
			}
		}
	}
}
